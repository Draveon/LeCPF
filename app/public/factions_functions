<?php
// NOTE DE DRAVEON A DRAVEON =
// REVOIR CONCEPTION POUR RECODAGE CAR CODE BANCAL ET DEFECTUEUUUUUX LALALA

include('connect.php');
include('session_joueur.php');

// VARIABLES
$joueur = $_SESSION['nom'];
$Factions;
$FactionsId;
$nivFaction;
$prochPalier;
$tabDef = [];
$vicFaction = 0;
$defFaction = 0;
$nbCombatsVicFactionsJoueur = 0;
$x = 0;
$totalXpFac;
$moyNivFactionMembers;

//IMPORT des infos de la base (factions, factions_membres, combats_joueurs, guerre_factions)
$sqlDef = "SELECT DISTINCT(combat_joueurs.attaquant), combat_joueurs.defendant, combat_joueurs.victoire, factions_membres.faction_id, factions.nom, COUNT(combat_joueurs.victoire) AS nbVic
FROM factions_membres
INNER JOIN factions
ON factions.id = factions_membres.faction_id
INNER JOIN combat_joueurs
ON combat_joueurs.attaquant = factions_membres.nom_membre
WHERE combat_joueurs.victoire != 'Espionnage'
AND combat_joueurs.victoire != 'artisanat'
AND faction_id
IN (SELECT faction_id
	FROM factions_membres
	WHERE factions_membres.nom_membre = combat_joueurs.defendant)
AND combat_joueurs.defendant = combat_joueurs.victoire
GROUP BY combat_joueurs.defendant";

$sqlFactions = "SELECT factions.id, factions.nom, factions.niv, factions.prochpalier
FROM factions INNER JOIN factions_membres ON factions_membres.faction_id = factions.id WHERE factions_membres.nom_membre = ' ".$joueur." ' ";
$reqFactions = mysql_query($sqlFactions) or die(mysql_error());
$reqDef = mysql_query($sqlDef) or die(mysql_error());


function getFaction() {
// récupère la faction
$sqlFactions = "SELECT factions.id, factions.nom, factions.niv, factions.prochpalier
FROM factions INNER JOIN factions_membres ON factions_membres.faction_id = factions.id WHERE factions_membres.nom_membre = ' ".$joueur." ' ";
$reqFactions = mysql_query($sqlFactions) or die(mysql_error());
	while ($row = mysql_fetch_assoc($reqFactions)) {
		return $row['id'];
	}
}
function checkIfFactionIsUpdated($factionId) {
// vérifie si la faction peut être mise à jour

$sqlFactions = mysql_query("SELECT DISTINCT factions.id, factions.nom, factions.niv, factions.prochpalier, factions.maj_new_niv FROM factions INNER JOIN factions_membres ON factions_membres.faction_id = factions.id WHERE factions_membres.faction_id = ".$factionId." ");
$data = mysql_fetch_assoc($sqlFactions);
	$isUpdated = $data['maj_new_niv'];
	return $isUpdated;
}



// Remplissage noms factions
while ($dataFactions = mysql_fetch_array($reqFactions)) {
   $Factions = $dataFactions['nom'];
   array_push($FactionsId = $dataFactions['id']);
   $nivFaction = $dataFactions['niv'];
   $prochPalier = $dataFactions['prochpalier'];
}
function getRangJoueur($joueur) {
	$factionId = getFactionIdByMember($joueur);
	addRang($factionId);
}
// MISE A JOUR DES infos de factions
function executeMajFaction($joueur, $factionId, $palierVic, $nivFaction) {
	// echo "maj faction";
	mysql_query("UPDATE factions set maj_new_niv = 1 WHERE factions.id = ".$factionId." ");
		gainNivFactions($factionId, $palierVic, $nivFaction);
		envoiMessageFactionGainNiv($factionId, $joueur);
		if ($actual_db == 1) {
			supprimerCombatsFac($factionId);

		}

	}

// VICTOIRES DE LA FACTION
// EN ATTAQUE
function vicFacAtt($faction) {
  global $vicFactionsAtt;
	global $vicFaction;
  $sqlVicFacAtt = "SELECT COUNT(combat_factions.victoire) as Vic
  FROM factions_membres
  INNER JOIN joueurs_bonus
  ON joueurs_bonus.nom = factions_membres.nom_membre
  INNER JOIN factions
  ON factions_membres.faction_id = factions.id
  INNER JOIN combat_factions
  ON combat_factions.attaquant = factions_membres.nom_membre
  WHERE combat_factions.victoire != 'Espionnage'
  AND combat_factions.victoire != 'artisanat'
  AND combat_factions.victoire != 'Foire'
  AND combat_factions.victoire != ''
  AND factions.id = '".$faction."'
  AND combat_factions.defendant != combat_factions.victoire
  GROUP BY factions.nom";
  $reqVicFacAtt = mysql_query($sqlVicFacAtt) or die(mysql_error());
  // Victoires attaquant
  $dataVicFacAtt = mysql_fetch_array($reqVicFacAtt);
  	$vicFactionsAtt = $dataVicFacAtt[0];
		$vicFaction = $dataVicFacAtt[0];

		return $vicFaction;
}
// VICTOIRES DE LA FACTION
// EN DEFENSE
function vicFacDef($faction) {
  global $vicFactionsDef;
	global $defFaction;
  $sqlVicFacDef = "SELECT COUNT(combat_factions.victoire) as Vic
  FROM factions_membres
  INNER JOIN joueurs_bonus
  ON joueurs_bonus.nom = factions_membres.nom_membre
  INNER JOIN factions
  ON factions_membres.faction_id = factions.id
  INNER JOIN combat_factions
  ON combat_factions.defendant = factions_membres.nom_membre
  WHERE combat_factions.victoire != 'Espionnage'
  AND combat_factions.victoire != 'artisanat'
  AND combat_factions.victoire != 'Foire'
  AND combat_factions.victoire != ''
  AND factions.id = '".$faction."'
  AND combat_factions.defendant = combat_factions.victoire
  GROUP BY factions.nom";
  $reqVicFacDef = mysql_query($sqlVicFacDef) or die(mysql_error());
  // Victoires defendant
  $dataVicFacDef = mysql_fetch_array($reqVicFacDef);
  	$vicFactionsDef = $dataVicFacDef[0];
  	$defFaction = $dataVicFacDef[0];

		return $defFaction;
}
function getNbCombatByMember($faction, $joueur) {
	$reqNbCombatsFacJoueur = mysql_query("SELECT COUNT(combat_factions.victoire) as Vic
	FROM factions_membres
	INNER JOIN joueurs_bonus
	ON joueurs_bonus.nom = factions_membres.nom_membre
	INNER JOIN factions
	ON factions_membres.faction_id = factions.id
	INNER JOIN combat_factions
	ON combat_factions.attaquant = factions_membres.nom_membre
	WHERE combat_factions.victoire != 'Espionnage'
	AND combat_factions.victoire != 'artisanat'
	AND combat_factions.victoire != 'Foire'
	AND combat_factions.victoire != ''
	AND factions.id = '".$faction."'
	AND combat_factions.victoire = '".$joueur."'
	GROUP BY factions.nom") or die(mysql_error());
	$dataVicFacJoueur = mysql_fetch_array($reqNbCombatsFacJoueur);
  	$nbCombatsVicFactionsJoueur = $dataVicFacJoueur[0];
		return $nbCombatsVicFactionsJoueur;
}
// total d'xp gagné par la faction (faction id)
function getTotalXpFaction($faction) {
	global $totalXpFac;
	$reqXPFacAtt = mysql_query("SELECT ROUND(AVG(combat_factions.xpAtt))
  FROM combat_factions
  WHERE combat_factions.victoire != 'Espionnage'
  AND combat_factions.victoire != 'artisanat'
  AND combat_factions.victoire != 'Foire'
  AND combat_factions.victoire != ''
  AND combat_factions.victoire = combat_factions.attaquant
  AND combat_factions.factionAtt = '".$faction."'
  ");
	$reqXPFacDef = mysql_query("SELECT ROUND(AVG(combat_factions.xpDef))
  FROM combat_factions
  WHERE combat_factions.victoire != 'Espionnage'
  AND combat_factions.victoire != 'artisanat'
  AND combat_factions.victoire != 'Foire'
  AND combat_factions.victoire != ''
  AND combat_factions.victoire = combat_factions.defendant
  AND combat_factions.factionAtt = '".$faction."'
  ");
	$dataXpFacAtt = 0;
	$dataXpFacDef = 0;
	while ($data = mysql_fetch_array($reqXPFacAtt)) {
		$dataXpFacAtt = $data[0];
	}
	while ($data = mysql_fetch_array($reqXPFacDef)) {
		$dataXpFacDef = $data[0];
	}
	$totalXpFac = $dataXpFacAtt+$dataXpFacDef;

	return $totalXpFac;
}
// moyenne des niveaux (faction id)
function getMoyNivFacMembers($faction) {
	$reqMoyNivFactionMembers = mysql_query("SELECT ROUND(AVG(joueurs_stats.niveau))
  	FROM joueurs_stats INNER JOIN factions_membres
	ON factions_membres.nom_membre = joueurs_stats.nom
  	WHERE factions_membres.faction_id = '".$faction."' ");
	while ($data = mysql_fetch_array($reqMoyNivFactionMembers)) {
		$moyNivFactionMembers = $data[0];
	}
	return $moyNivFactionMembers;
}
// Calcul de l'xp gagnée par le joueur
function calculateXP($factionId, $joueur) {
	$nivJoueur = 0;
	$nbJ = 0;
	$nbVicJoueur = 0;
	$nbDefJoueur = 0;
	$joueurActif = 1;
	// avant maj d'xp
	$nbTotalVicDefJoueurAvant = 0;
	// apres maj d'xp
	$nbTotalVicDefJoueurApres = 0;
	$reqNbCombatJoueur = mysql_query("SELECT joueurs_bonus.nbrCombats FROM joueurs_bonus WHERE joueurs_bonus.nom = '".$joueur."' ");
	$totalXpFac = getTotalXpFaction($factionId);
	$moyNivFactionMembers = getMoyNivFacMembers($factionId);
	$nbCombatsVicFactionsJoueur = getNbCombatByMember($factionId, $joueur);

	$reqNbMbr = mysql_query("SELECT COUNT(factions_membres.id_membre) FROM joueurs_stats INNER JOIN factions_membres ON factions_membres.nom_membre = joueurs_stats.nom INNER JOIN joueurs_bonus ON joueurs_bonus.nom = joueurs_stats.nom WHERE factions_membres.faction_id = '".$factionId."' AND joueurs_bonus.victoire + joueurs_bonus.`défaite` > 0 ");

	$reqNivJ = mysql_query("SELECT joueurs_stats.niveau FROM joueurs_stats INNER JOIN factions_membres ON factions_membres.nom_membre = joueurs_stats.nom WHERE factions_membres.faction_id = '".$factionId."' AND joueurs_stats.nom = '".$joueur."' ");

	$reqNbVic = mysql_query("SELECT joueurs_bonus.victoire FROM joueurs_stats INNER JOIN joueurs_bonus ON joueurs_bonus.nom = joueurs_stats.nom WHERE joueurs_stats.nom = '".$joueur."' ");

	$reqNbDef = mysql_query("SELECT joueurs_bonus.`défaite` FROM joueurs_stats INNER JOIN joueurs_bonus ON joueurs_bonus.nom = joueurs_stats.nom WHERE joueurs_stats.nom = '".$joueur."' ");

	while ($data = mysql_fetch_array($reqNivJ)) {
		$nivJoueur = $data[0];
	}
	while ($data = mysql_fetch_array($reqNbMbr)) {
		$nbJ = $data[0];
	}
	while ($data = mysql_fetch_array($reqNbVic)) {
		$nbVicJoueur = $data[0];
	}
	while ($data = mysql_fetch_array($reqNbDef)) {
		$nbDefJoueur = $data[0];
	}
	while ($data = mysql_fetch_array($reqNbCombatJoueur)) {
		$nbTotalVicDefJoueurAvant = $data[0];
	}
	$nbTotalVicDefJoueurApres = $nbVicJoueur+$nbDefJoueur;

	// Si le joueur a fait des combats depuis la dernière fois c'est qu'il est actif
	if ($nbTotalVicDefJoueurApres > $nbTotalVicDefJoueurAvant) {
		// On met a jour les combats
		mysql_query("UPDATE joueurs_bonus SET joueurs_bonus.nbrCombats = '".$nbTotalVicDefJoueurApres."' WHERE nom = '".$joueur."' ");
	}
		$xpMbr = round((((($totalXpFac*$nivJoueur)/$nbJ)/$moyNivFactionMembers)*10));

	mysql_query("UPDATE joueurs_stats SET lastXpFac = '".$xpMbr."' WHERE nom = '".$joueur."' ");
	return $xpMbr;
}


function nbMembers($factionId) {
	$nbMembers = 0;
	$req = mysql_query("SELECT COUNT(factions_membres.nom_membre) FROM factions_membres INNER JOIN factions ON factions.id = factions_membres.faction_id WHERE faction_id = '".$factionId."' ");
	while ($data = mysql_fetch_array($req)) {
		$nbMembers = $data[0];
	}
	return $nbMembers;
}
// Gain d'XP pour le joueur
function gainXpMbrFaction($factionId) {
	if ($joueur == "Draveon")
	echo "gain xp";
	$arrayMbr = [];
	//maj de l'xp
	$members = mysql_query("SELECT nom_membre FROM factions_membres WHERE faction_id = ".$factionId." ");
	while ($row = mysql_fetch_assoc($members)) {
		array_push($arrayMbr, $row['nom_membre']);

	}

	foreach($arrayMbr as $mbrFacToWhoGiveXp) {
		$xp = calculateXP($factionId, $mbrFacToWhoGiveXp);

		if ($joueur == "Draveon")
		echo ", xp de membre : ".$xp;

		/*mysql_query("UPDATE factions_membres
		INNER JOIN joueurs_stats
		ON joueurs_stats.nom = factions_membres.nom_membre
		INNER JOIN factions
		ON factions.id = factions_membres.faction_id
		SET joueurs_stats.xp = joueurs_stats.xp + ".$xp."
		WHERE factions_membres.nom_membre = '".$mbrFacToWhoGiveXp."' ");*/
	}


}
//Méthode envoi de message vers membres d'une faction pour avertir du gain d'xp
function envoiMessageFactionGainNiv($factionId, $joueur) {
if ($joueur == "Evadorn")
	echo "envoi message";

	$xp = " ceci est un test, faire comme si de rien n'était... ";
	$req = mysql_query("SELECT lastXpFac FROM joueurs_stats WHERE nom = '".$joueur."'");
	while ($data = mysql_fetch_row($req)) {
		$xp = $data[0];
	}
	$temps = time()/1000;
	// $date = date('m-d', $temps*1000);
	$nom_jour_fr = array("dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi");
$mois_fr = Array("", "janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août",
        "septembre", "octobre", "novembre", "décembre");
// on extrait la date du jour
list($nom_jour, $jour, $mois, $annee) = explode('/', date("w/d/n/Y"));
$date = $jour.' '.$mois_fr[$mois];
//Affichera par exemple : "date du jour en français : samedi 24 juin 2006."
	$message = "Votre faction s\'est imposée face aux autres ! ";
	$message .= "De ce fait, vous récoltez votre part du butin : ";
	$message .= $xp;
	$message .= " xp";

	//envoi à tous les membres en une fois
	$sqlMembersFac = 'Draveon';
	$listeMembersFac = array();
		while($row = mysql_fetch_assoc($sqlMembersFac)) {
			// array_push($listeMembersFac = $row['nom_membre']);
			array_push($listeMembersFac = $sqlMembersFac);
		}
    foreach ($listeMembersFac as $mbrFac) {

    	$req = "INSERT INTO messagerie (auteur, destinataire, titre, message, `date`, temps)
					VALUES 	('Messager'	, 'Draveon'	, 'Votre Faction connaît la gloire !'	, '".$message."'	, '".$date."'	, '".$temps."') ";
					// echo $req;
		mysql_query($req) or die(mysql_error());
    }


}
function randomRewards($joueur) {
	$randReward = 1;
	// $randReward = mt_rand(0, 2);
	if ($randReward == 1) {
		//pts d'aptitudes
		$ptsAptRand = 10;
		mysql_query("UPDATE `joueurs_aptitudes_base` SET `points` =  `points` + ".$ptsAptRand." WHERE `joueurs_aptitudes_base`.`nom` = '".$joueur."' ");
	}
	if ($randReward == 2) {
		//ressources
		$ressourcesRand = mt_rand(30, 50);
		mysql_query("UPDATE `joueurs_stats` SET `soufre` = `soufre` + '".$ressourcesRand."', `mercure` = `mercure` + '".$ressourcesRand."', `cristal` = `cristal` + '".$ressourcesRand."', `gemme` = `gemme` + '".$ressourcesRand."' WHERE `joueurs_stats`.`nom` = '".$joueur."' ");
	} if ($randReward == 0) {
		//objet
		// RÉSOLUTION DES MISSIONS
		require_once ('info_objets_include.php');

		// On donne un objet pour chaque mission accomplie
			$places_libres = places_libres_inv($joueur);
			if ($places_libres <= 0) {
				$randReward = mt_rand(1, 2);
				if ($randReward == 1) {
					//pts d'aptitudes
					$ptsAptRand = 10;
					mysql_query("UPDATE `joueurs_aptitudes_base` SET `points` = '".$ptsAptRand."' WHERE `joueurs_aptitudes_base`.`id` = '".$joueur."' ");
				} else if ($randReward == 2) {
					//ressources
					$ressourcesRand = mt_rand(30, 50);
					mysql_query("UPDATE `joueurs_stats` SET `soufre` = `soufre` + '".$ressourcesRand."', `mercure` = `mercure` + '".$ressourcesRand."', `cristal` = `cristal` + '".$ressourcesRand."', `gemme` = `gemme` + '".$ressourcesRand."' WHERE `joueurs_stats`.`id` = '".$joueur."' ");
				}
			} else {
				$req = mysql_query ("SELECT id, nom, image, type, niv FROM objets_stats WHERE trouvable = '1' ORDER BY RAND() LIMIT 1") or die ('Erreur SQL !<br>'.mysql_error());
				$data = mysql_fetch_assoc($req);
				$item = creer_objet($data['id']);
				ajouteDansInventaire ( $joueur, $item );
			}
		// FIN DON RECOMPENSES
	}
}
// function envoiMessageFactionEnnemieVic($factionId) {
// 	$facgagnante = "";
// 	$req = mysql_query("SELECT nom from factions WHERE id = '".$factionId."' ");
// 	while ($data = mysql_fetch_array($req)) {
// 		$facgagnante = $data[0];
// 	}
// 	$temps = time()/1000;
// 	// $date = date('m-d', $temps*1000);
// 	$nom_jour_fr = array("dimanche", "lundi", "mardi", "mercredi", "jeudi", "vendredi", "samedi");
// $mois_fr = Array("", "janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août",
//         "septembre", "octobre", "novembre", "décembre");
// // on extrait la date du jour
// list($nom_jour, $jour, $mois, $annee) = explode('/', date("w/d/n/Y"));
// $date = $jour.' '.$mois_fr[$mois];
// //Affichera par exemple : "date du jour en français : samedi 24 juin 2006."
// 	$message = " '".$facgagnante."' vient de progresser d'un niveau !";
// 	$req = "INSERT INTO messagerie (auteur, destinataire, titre, message, `date`, temps)
// 					VALUES 	('Messager'	, 'tous'	, 'Une faction se renforce !'	, '".$message."'	, '".$date."'	, '".$temps."') ";
// 					// echo $req;
// 		mysql_query($req) or die(mysql_error());
// }

function supprimerCombatsFac($factionId) {
	mysql_query("DELETE `combat_factions` FROM `combat_factions` INNER JOIN factions_membres ON factions_membres.nom_membre = combat_factions.victoire WHERE factions_membres.faction_id = '".$factionId."' ");
}

function getFactionIdByMember($joueur) {
	$sqlGetFID = "SELECT factions.id, factions_membres.nom_membre FROM factions INNER JOIN factions_membres ON factions_membres.faction_id = factions.id WHERE factions_membres.nom_membre = '".$joueur."'";
	$reqFID = mysql_query($sqlGetFID) or die(mysql_error());
	$reqData = mysql_fetch_array($reqFID);
			return $reqData[0];
}
function getFactionPalierByMember($joueur) {
	$sqlGetFID = "SELECT factions.prochpalier, factions_membres.nom_membre FROM factions INNER JOIN factions_membres ON factions_membres.faction_id = factions.id WHERE factions_membres.nom_membre = '".$joueur."'";
	$reqFID = mysql_query($sqlGetFID) or die(mysql_error());
	$reqData = mysql_fetch_array($reqFID);
			return $reqData[0];
}
function getFactionNivByMember($joueur) {
	$sqlGetFNIV = "SELECT factions.niv FROM factions INNER JOIN factions_membres ON factions.id = factions_membres.faction_id WHERE nom_membre = '".$joueur."' ";
	$reqFNIV = mysql_query($sqlGetFNIV) or die(mysql_error());
	$reqDataToReturn;
	while ($reqData = mysql_fetch_array($reqFNIV)) {
		$reqDataToReturn = $reqData[0];
	}

	return $reqDataToReturn;
}



function gainNivFactions($factionId, $palierVic, $nivFaction) {

    //maj de l'xp
    $sql = "UPDATE factions SET niv = niv + 1 WHERE factions.id = '".$factionId."' ";
    $req = mysql_query($sql) or die(mysql_error());



		// On met à jour les paliers
		majPalierFaction($factionId, $palierVic);
}

function majPalierFaction($factionId, $palierVic) {


// var_dump($palierVic);
    //maj de l'xp

    $sql = "UPDATE factions SET prochpalier = prochpalier + 5 WHERE id = '".$factionId."' ";
    $req = mysql_query($sql) or die(mysql_error());
		mysql_query("UPDATE factions SET `maj_new_niv` = 0");

	// On distribue l'xp aux membres

	 gainXpMbrFaction($factionId);

  return $palierVic;
}
function getPaliers($facId) {
  $sql = "SELECT prochpalier FROM factions WHERE id = '".$facId."' ";
  $req = mysql_query($sql) or die(mysql_error());
	$z = 0;
	$palier = null;
	while ($data = mysql_fetch_array($req)) {
		$palier = $data[0];
		$z++;
	}
	return $palier;
}

function addHeroToFaction() {

//fait rejoindre une faction à un personnage
$id = $_SESSION['id'];
$nom = $_SESSION['nom'];
$race = $_SESSION['race'];


	switch ($race){
		//Les Six Lames
		case 'Célestial': $faction = 1; break;
		case 'Fétide': $faction = 1; break;
		case 'Sahuagin': $faction = 1; break;
		case 'Septentrional': $faction = 1; break;
		case 'Ashtar': $faction = 1; break;
		case 'Malakeh': $faction = 1; break;

		//L'Ordre Impérial
		case 'Elfe': $faction = 2; break;
		case 'Homme': $faction = 2; break;
		case 'Nain': $faction = 2; break;
		case 'Ancien': $faction = 2; break;
		case 'Gnome': $faction = 2; break;
		case 'Fée': $faction = 2; break;

		//Les Disciples du Chaos
		case 'Vampire': $faction = 3; break;
		case 'Orque': $faction = 3; break;
		case 'Infernal': $faction = 3; break;
		case 'Minotaure': $faction = 3; break;
		case 'Géant': $faction = 3; break;
		case 'Elfe Noir': $faction = 3; break;

	}
	//Commandes SQL nécessaires :

			$sqlAjoutMembre = "INSERT INTO `factions_membres` (`id_membre`, `nom_membre`, `faction_id`) VALUES ('".$id."', '".$nom."', $faction);";
			$sqlMAJMembre = "UPDATE `factions_membres` SET `faction_id` = $faction WHERE nom_membre = '".$nom."' ";

			$sqlNomFaction = "SELECT nom, image, descr FROM `factions` WHERE id = $faction";
	//On prépare la commande sql d'insertion si le personnage n'est pas déjà présent dans une faction
			$reqCondition = mysql_query("SELECT COUNT(nom_membre) FROM `factions_membres` WHERE nom_membre = '".$nom."' ")or die('Erreur SQL !<br>'.$sql.'<br>'.mysql_error());
			$res = mysql_fetch_array($reqCondition);

				//Si le personnage n'est pas inscrit dans une faction
				if ($res[0] == 0) {
					//On l'ajoute
					$reqAjoutMembre = mysql_query($sqlAjoutMembre) or die('Erreur SQL !<br>'.$sql.'<br>'.mysql_error());
				} else if ($res[0] == 1) {
				//Si déjà inscrit on met à jour sa faction au cas où il a reset
					$reqAjoutMembre = mysql_query($sqlMAJMembre) or die('Erreur SQL !<br>'.$sql.'<br>'.mysql_error());
				}


}
function addRang($faction) {

	$req = mysql_query("SELECT DISTINCT nom_membre, `joueurs_heros`.titre, `joueurs_heros`.royaume, `joueurs_heros`.race, `joueurs_heros`.classe, `joueurs_bonus`.rangFaction, `joueurs_stats`.niveau, `joueurs_heros`.puissance, `joueurs_heros`.id FROM `joueurs_heros` INNER JOIN `factions_membres` ON `joueurs_heros`.nom = `factions_membres`.nom_membre INNER JOIN `joueurs_bonus` ON `joueurs_bonus`.id = `joueurs_heros`.id INNER JOIN `joueurs_stats` ON `joueurs_stats`.id = `joueurs_heros`.id INNER JOIN combat_factions ON combat_factions.victoire = joueurs_heros.nom WHERE `factions_membres`.faction_id = '".$faction."' ORDER BY puissance DESC");
	while ($data = mysql_fetch_array($req)) {
//RANGS de faction
//Si faction =

//Six lames
if ($faction == 1  ) {
	//Si victoires inférieur à 20
	if ($data['victoire'] < 20) {
		$data['rangFaction'] = "Lame";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 20 && $data['victoire'] < 40) {
		$data['rangFaction'] = "Grande Lame";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 40 && $data['victoire'] < 60) {
		$data['rangFaction'] = "Mercenaire";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 80 && $data['victoire'] < 100) {
		$data['rangFaction'] = "Ecuyer d'Andeïn";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 100 && $data['victoire'] < 125) {
		$data['rangFaction'] = "Protecteur des Marginaux";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 125 && $data['victoire'] < 150) {
		$data['rangFaction'] = "Tacticien de Guerre";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 150) {
		$data['rangFaction'] = "Seigneur des Lames";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}

}
//Ordre Impérial
if ($faction == 2  ) {
	//Si victoires inférieur à 20
	if ($data['victoire'] < 20) {
		$data['rangFaction'] = "Soldat Impérial";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 20 && $data['victoire'] < 40) {
		$data['rangFaction'] = "Armurier Impérial";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 40 && $data['victoire'] < 60) {
		$data['rangFaction'] = "Capitaine de Garnison";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 80 && $data['victoire'] < 100) {
		$data['rangFaction'] = "Conseiller du Thane";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 100 && $data['victoire'] < 125) {
		$data['rangFaction'] = "Gardien du Livre Impérial";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 125 && $data['victoire'] < 150) {
		$data['rangFaction'] = "Descendant de Manassé";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 150) {
		$data['rangFaction'] = "Thane Impérial";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}

}

//Disciples du Chaos
if ($faction == 3  ) {
	//Si victoires inférieur à 20
	if ($data['victoire'] < 20) {
		$data['rangFaction'] = "Serviteur du Chaos";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 20 && $data['victoire'] < 40) {
		$data['rangFaction'] = "Dévot de Chezzer";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 40 && $data['victoire'] < 60) {
		$data['rangFaction'] = "Dépeceur Sanglant";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 80 && $data['victoire'] < 100) {
		$data['rangFaction'] = "Adorateur de Nucter";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 100 && $data['victoire'] < 125) {
		$data['rangFaction'] = "Collectionneur de Crânes";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 125 && $data['victoire'] < 150) {
		$data['rangFaction'] = "Profanateur de Tombes";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}
	if ($data['victoire'] >= 150) {
		$data['rangFaction'] = "Chef de la Horde";
		mysql_query("UPDATE joueurs_bonus SET rangFaction = '".$data['rangFaction']."' ");
	}

}
}
}
 ?>
